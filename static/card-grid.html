<link rel="import" href="bower_components/polymer/polymer.html">
<link rel="import" href="input-card.html">
<script src="bower_components/nativesortable/nativesortable.js"></script>
<script src="bower_components/knockout/dist/knockout.js"></script>
<link rel="import" href="bower_components/core-label/core-label.html">
<link rel="import" href="bower_components/paper-input/paper-input.html">
<link rel="import" href="bower_components/paper-fab/paper-fab.html">
<link rel="import" href="bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="bower_components/paper-checkbox/paper-checkbox.html">

<polymer-element name="card-grid">
    <template>
        <style shim-shadowdom>
            :host {
                display: block;
                width: 100%;
                height: 100%
            }

            input-card {
                margin-bottom: 10px;
            }

            ul {
                display: flex;
                flex-flow: row wrap;
                justify-content: space-between;
                list-style-type: none;
            }

            li {
                position: relative;
                flex: 0 0 8%;
                height: 140px;
                margin: 2% 2% 50px;
            }

            [draggable] {
                -moz-user-select: none;
                -khtml-user-select: none;
                -webkit-user-select: none;
                user-select: none;
            }

            [draggable] * {
                -moz-user-drag: none;
                -khtml-user-drag: none;
                -webkit-user-drag: none;
                user-drag: none;
            }

            #fabadd::shadow core-icon#icon{
                transform: rotate(-0.25turn);
                transition: .2s ease-in;
            }

            #fab_group:hover > #fabadd::shadow core-icon#icon{
                transform: rotate(0turn);
            }

            .fabadd {
                background-color: #56ac3e;
                transition: .2s ease-in;
            }

            .fabadd_select {
                background-color: #71ed4c;
            }
            .sub_fab {
                visibility: hidden;
            }
            .sub_fab_show {
                visibility: visible;
            }
            .sub_fab_show:hover {
                background-color: red;
            }
        </style>
        <div id="toplevel">
            <div id="fab_group" on-mouseover = "{{ handleHoverAdd }}" on-mouseout = "{{ handleHoverEnd }}" style="width: 150px; padding: 5px;" horizontal justified layout center>
                <paper-fab id="fabadd" icon="{{ icon }}" title="add" class = "fabadd"></paper-fab>
                <paper-fab id="addgrid" icon="view-module" title="add grid" mini on-tap="{{ handleAddCard }}" class = "sub_fab" ></paper-fab>
                <paper-fab id="addone" icon="note-add" title="add one card" mini on-tap="{{ handleAddCard }}" class = "sub_fab"></paper-fab>
            </div>
            <ul id='sortable' class='sortable'>
                <template repeat="{{sample in samples.samples}}">
                    <style>
                        paper-checkbox.blue::shadow #ink[checked] {
                            color: #4285f4;
                        }
                        paper-checkbox.blue::shadow #checkbox.checked {
                            border-color: #4285f4;
                        }
                    </style>
                    <li>
                        <input-card uid="{{ sample.uid }}" selected="{{ sample.selected }}" description="{{ sample.description }}" on-clear-tap="{{ handleClear }}" on-delete-tap="{{ handleClear }}" on-more-tap="{{ handleMore }}"
                                   class="card">

                            <paper-input draggable="false" value="{{ sample.username }}" label="Sample Name"
                                         class="sample"></paper-input>
                            <core-label center horizontal layout style="width: 100px">
                                <paper-checkbox flex class="blue" checked="{{ sample.subgrid }}" for></paper-checkbox>
                                <div>Sub Grid</div>
                            </core-label>

                        </input-card>
                    </li>
                </template>
            </ul>
        </div>
        <paper-dialog id = "more_dialog">
            <template bind="{{ samples.selected_sample as sample }}">
                <style>
                    paper-checkbox.blue::shadow #ink[checked] {
                        color: #4285f4;
                    }
                    paper-checkbox.blue::shadow #checkbox.checked {
                        border-color: #4285f4;
                    }
                </style>
                <input-card uid="{{ sample.uid }}" selected="{{ sample.selected }}" description="{{ sample.description }}" full="true" on-clear-tap="{{ handleClear }}" on-delete-tap="{{ handleClear }}" on-more-tap="{{ handleMore }}"
                                   class="card">

                            <paper-input draggable="false" value="{{ sample.username }}" label="Sample Name"
                                         class="sample"></paper-input>
                            <core-label center horizontal layout style="width: 100px">
                                <paper-checkbox flex class="blue" checked="{{ sample.subgrid }}" for></paper-checkbox>
                            </core-label>

                        </input-card>
            </template>
        </paper-dialog>
    </template>

    <script>
        Polymer({
            icon: "add",
            handleHoverAdd: function(event, detail, sender) {
                var self = this;

                setTimeout(function () {
                    if (self.$.fabadd.classList.contains('fabadd_select') == true) {
                        self.icon = "create";
                    }
                }, 150);

                this.$.addgrid.classList.add('sub_fab_show');
                this.$.addone.classList.add('sub_fab_show');
                this.$.fabadd.classList.add('fabadd_select');

            },
            handleHoverEnd: function(event, detail, sender) {
               var self = this;

                setTimeout(function () {
                    if (self.$.fabadd.classList.contains('fabadd_select') == false) {
                        self.icon = "add";
                    }
                }, 50);

                this.$.addgrid.classList.remove('sub_fab_show');
                this.$.addone.classList.remove('sub_fab_show');
                this.$.fabadd.classList.remove('fabadd_select');


            },
            handleClear: function (event, detail, sender) {
                this.samples.remove_by_uid(sender.uid, event.type == 'clear-tap')

            },
            handleMore: function (event, detail, sender) {
                var d = this.$.more_dialog;
                d.toggle();
                console.log(this.samples.selected_sample);
                this.samples.select_by_uid(sender.uid);
                //this.$.service.setFavorite(post.uid, post.favorite)
            },
            handleAddCard: function (event, detail, sender){
                if (sender.id == 'addgrid'){
                    this.samples.new_grid();
                } else {
                    this.samples.add_sample();
                }
            },
            ready: function () {

                this.$.toplevel.addEventListener("mousedown", function(event){
                    if (event.toElement.id == 'sortable'){
                        this.selecting = true;
                        this.position1 = [event.x, event.y];
                        this.style.cursor = 'crosshair';
                        console.log(this.childNodes);
                    }
                });

                this.$.toplevel.addEventListener("mouseup", function(event){
                    if (this.selecting == true) {
                        this.style.cursor = 'auto';
                        this.selecting = false;
                    }

                });

                this.$.toplevel.addEventListener("mousemove", function(event){
                    if (this.selecting == true) {
                        console.log(event.x, event.y);
                    }
                });

                var sortable = this.$.sortable;
                nativesortable(sortable, {
                    change: function () {
                        console.log('move');
                    },
                    warp: false //With warp true elements swap places
                });

                function samples() {
                    var self = this;
                    self.uid = 0;
                    self.samples = [];
                    self.selected_sample = {};
                    self.add_sample = function () {
                        self.samples.push({'uid': self.uid, 'selected': true, 'description': '', 'subgrid': false});
                        self.uid++;
                    };
                    self.new_grid = function () {
                        self.uid = 0;
                        self.samples = [];
                        for (var i = 0; i < 40; i++) {
                            self.add_sample()
                        }
                        self.selected_sample = self.samples[0]
                    };
                    self.remove_by_uid = function (uid, clearonly) {
                        clearonly = clearonly || false;
                        var index = 0;
                        self.samples.some(function (sample) {
                            if (sample.uid == uid) {
                                if (clearonly == true) {
                                    self.samples[index] = {'uid': uid, 'selected': true, 'description': '', 'subgrid': false}
                                } else {
                                    self.samples.splice(index, 1);
                                }
                                return true
                            }
                            index++;
                        });
                    };
                    self.select_by_uid = function (uid) {
                        var index = 0;
                        self.samples.some(function (sample) {
                            if (sample.uid == uid) {
                                self.selected_sample = sample;
                                return true;
                            }
                            index++;
                        });
                    };
                }
                this.samples = new samples();
            }
        });

    </script>

</polymer-element>

